rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is accessing their own data
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Helper function to check if user has guard role
    // Note: Document ID may be different from auth.uid, so we check by uid field
    function isGuard() {
      return isAuthenticated() &&
             (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'guard' ||
              exists(/databases/$(database)/documents/users/$(request.auth.uid)) == false);
    }

    // Helper function to check if user has admin role
    function isAdmin() {
      return isAuthenticated() &&
             (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
              exists(/databases/$(database)/documents/users/$(request.auth.uid)) == false);
    }

    // Users collection
    match /users/{userId} {
      // Users can read their own profile
      // Guards and admins can read all users
      allow read: if isAuthenticated() && (isOwner(userId) || isGuard() || isAdmin());

      // Users can create their own profile document (during registration)
      // The document ID must match their auth UID
      allow create: if isAuthenticated() &&
                    request.auth.uid == userId &&
                    request.resource.data.uid == request.auth.uid;

      // Users can update their own profile (limited fields)
      allow update: if isOwner(userId) &&
                    request.resource.data.diff(resource.data).affectedKeys()
                    .hasOnly(['fcmToken', 'lastLogin', 'photoUrl']);

      // Only admins can delete users
      allow delete: if isAdmin();
    }

    // Access logs collection
    match /accessLogs/{logId} {
      // Users can read their own access logs
      // Guards and admins can read all logs
      allow read: if isAuthenticated() &&
                  (resource.data.userId == request.auth.uid || isGuard() || isAdmin());

      // Only guards can create access logs
      allow create: if isGuard();

      // No one can update or delete access logs
      allow update, delete: if false;
    }

    // Gates collection
    match /gates/{gateId} {
      // All authenticated users can read gates
      allow read: if isAuthenticated();

      // Only admins can manage gates
      allow write: if isAdmin();
    }

    // Notifications collection
    match /notifications/{notificationId} {
      // Users can read their own notifications
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Only system (admin) can create notifications
      allow create: if isAdmin();

      // Users can update their own notifications (mark as read)
      allow update: if isAuthenticated() &&
                    resource.data.userId == request.auth.uid &&
                    request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead']);
    }

    // Contractors collection
    match /contractors/{contractId} {
      // All authenticated users can read contractors
      allow read: if isAuthenticated();

      // Only admins can manage contractors
      allow write: if isAdmin();
    }

    // Legacy: Vehicles collection
    match /vehicles/{vehicleId} {
      allow read: if isAuthenticated() &&
                  (resource.data.userId == request.auth.uid || isGuard() || isAdmin());
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAdmin();
    }

    // Legacy: Registrations collection
    match /registrations/{registrationId} {
      allow read: if isAuthenticated() &&
                  (resource.data.userId == request.auth.uid || isGuard() || isAdmin());
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() &&
                    (resource.data.userId == request.auth.uid || isGuard() || isAdmin());
      allow delete: if isAdmin();
    }

    // Legacy: CheckInOuts collection
    match /checkInOuts/{checkInOutId} {
      allow read: if isAuthenticated() &&
                  (resource.data.userId == request.auth.uid || isGuard() || isAdmin());
      allow create: if isGuard();
      allow update: if isGuard();
      allow delete: if false;
    }

    // Gate Access Registrations collection
    match /gateAccessRegistrations/{registrationId} {
      // Users can read their own registrations
      // Guards and admins can read all registrations
      allow read: if isAuthenticated() &&
                  (resource.data.userId == request.auth.uid || isGuard() || isAdmin());

      // Authenticated users can create registrations for themselves (pending status)
      // Guards can create registrations for walk-in visitors (with createdBy field)
      allow create: if isAuthenticated() &&
                    ((request.resource.data.userId == request.auth.uid &&
                      request.resource.data.status == 'pending') ||
                     (isGuard() &&
                      request.resource.data.createdBy == request.auth.uid));

      // Users can cancel their own pending registrations
      // Guards and Admins can update any registration (for check-in/out, QR generation, approve/reject)
      // Temporarily allow all authenticated users to update for guard app functionality
      allow update: if isAuthenticated();

      // Only admins can delete registrations
      allow delete: if isAdmin();
    }

    // Visitor Access Logs collection (check-in/check-out history)
    match /visitorAccessLogs/{logId} {
      // All authenticated users can read visitor access logs
      allow read: if isAuthenticated();

      // All authenticated users can create visitor access logs (for guard app)
      allow create: if isAuthenticated();

      // Logs should not be modified or deleted (audit trail)
      allow update, delete: if false;
    }
  }
}
